#include "game/exploit-sequencer/exploit-sequencer-states.hpp"
#include "game/exploit-sequencer/exploit-sequencer.hpp"
#include "game/exploit-sequencer/exploit-sequencer-resources.hpp"
#include "device/drivers/logger.hpp"

static const char* TAG = "ExploitSeqIntro";

ExploitSequencerIntro::ExploitSequencerIntro(ExploitSequencer* game) : State(EXPLOIT_INTRO) {
    this->game = game;
}

ExploitSequencerIntro::~ExploitSequencerIntro() {
    game = nullptr;
}

void ExploitSequencerIntro::onStateMounted(Device* PDN) {
    transitionToShowState = false;

    LOG_I(TAG, "Exploit Sequencer intro");

    // Reset session for a fresh game
    game->getSession().reset();
    game->resetGame();
    game->setStartTime(SimpleTimer::getPlatformClock()->milliseconds());
    game->seedRng();

    // Display title screen
    PDN->getDisplay()->invalidateScreen();
    PDN->getDisplay()->setGlyphMode(FontMode::TEXT)
        ->drawText("EXPLOIT SEQUENCER", 10, 20)
        ->drawText("Inject the code.", 10, 45);
    PDN->getDisplay()->render();

    // Idle LED animation â€” orange/amber pulse
    AnimationConfig config;
    config.type = AnimationType::VERTICAL_CHASE;
    config.speed = 3;
    config.curve = EaseCurve::EASE_IN_OUT;
    config.initialState = EXPLOIT_SEQ_IDLE_STATE;
    config.loopDelayMs = 800;
    config.loop = true;
    PDN->getLightManager()->startAnimation(config);

    // Start intro timer
    introTimer.setTimer(INTRO_DURATION_MS);
}

void ExploitSequencerIntro::onStateLoop(Device* PDN) {
    if (introTimer.expired()) {
        transitionToShowState = true;
    }
}

void ExploitSequencerIntro::onStateDismounted(Device* PDN) {
    introTimer.invalidate();
    transitionToShowState = false;
}

bool ExploitSequencerIntro::transitionToShow() {
    return transitionToShowState;
}
