#include "game/exploit-sequencer/exploit-sequencer-states.hpp"
#include "game/exploit-sequencer/exploit-sequencer.hpp"
#include "game/exploit-sequencer/exploit-sequencer-resources.hpp"
#include "device/drivers/logger.hpp"
#include <string>

static const char* TAG = "ExploitSeqLose";

ExploitSequencerLose::ExploitSequencerLose(ExploitSequencer* game) : State(EXPLOIT_LOSE) {
    this->game = game;
}

ExploitSequencerLose::~ExploitSequencerLose() {
    game = nullptr;
}

void ExploitSequencerLose::onStateMounted(Device* PDN) {
    transitionToIntroState = false;

    auto& session = game->getSession();
    auto& config = game->getConfig();

    bool isHard = (config.timingWindow <= 6 && config.failsAllowed <= 1);

    MiniGameOutcome loseOutcome;
    loseOutcome.result = MiniGameResult::LOST;
    loseOutcome.score = session.score;
    loseOutcome.hardMode = isHard;
    game->setOutcome(loseOutcome);

    LOG_I(TAG, "EXPLOIT FAILED â€” score %d", session.score);

    PDN->getDisplay()->invalidateScreen();
    PDN->getDisplay()->setGlyphMode(FontMode::TEXT)
        ->drawText("EXPLOIT FAILED", 10, 25);

    std::string scoreStr = "Score: " + std::to_string(session.score);
    PDN->getDisplay()->drawText(scoreStr.c_str(), 30, 50);
    PDN->getDisplay()->render();

    // Lose LED animation
    AnimationConfig animConfig;
    animConfig.type = AnimationType::IDLE;
    animConfig.initialState = EXPLOIT_SEQ_LOSE_STATE;
    animConfig.loop = false;
    PDN->getLightManager()->startAnimation(animConfig);

    PDN->getHaptics()->setIntensity(255);

    loseTimer.setTimer(LOSE_DISPLAY_MS);
}

void ExploitSequencerLose::onStateLoop(Device* PDN) {
    if (loseTimer.expired()) {
        PDN->getHaptics()->off();
        if (!game->getConfig().managedMode) {
            transitionToIntroState = true;
        } else {
            PDN->returnToPreviousApp();
        }
    }
}

void ExploitSequencerLose::onStateDismounted(Device* PDN) {
    loseTimer.invalidate();
    transitionToIntroState = false;
    PDN->getHaptics()->off();
}

bool ExploitSequencerLose::transitionToIntro() {
    return transitionToIntroState;
}

bool ExploitSequencerLose::isTerminalState() const {
    return game->getConfig().managedMode;
}
