#include "game/exploit-sequencer/exploit-sequencer-states.hpp"
#include "game/exploit-sequencer/exploit-sequencer.hpp"
#include "game/exploit-sequencer/exploit-sequencer-resources.hpp"
#include "device/drivers/logger.hpp"

static const char* TAG = "ExploitSeqEvaluate";

ExploitSequencerEvaluate::ExploitSequencerEvaluate(ExploitSequencer* game) : State(EXPLOIT_EVALUATE) {
    this->game = game;
}

ExploitSequencerEvaluate::~ExploitSequencerEvaluate() {
    game = nullptr;
}

void ExploitSequencerEvaluate::onStateMounted(Device* PDN) {
    transitionToShowState = false;
    transitionToWinState = false;
    transitionToLoseState = false;

    auto& session = game->getSession();
    auto& config = game->getConfig();

    // Determine hit or miss
    bool isHit = false;
    if (session.playerPressed) {
        int dist = session.symbolPosition - config.markerPosition;
        if (dist < 0) dist = -dist;
        isHit = (dist <= config.timingWindow);
    }

    if (isHit) {
        session.score += 100;
        LOG_I(TAG, "HIT! pos=%d marker=%d window=%d score=%d",
            session.symbolPosition, config.markerPosition, config.timingWindow, session.score);

        // Brief green flash
        AnimationConfig animConfig;
        animConfig.type = AnimationType::IDLE;
        animConfig.initialState = EXPLOIT_SEQ_HIT_STATE;
        animConfig.loop = false;
        PDN->getLightManager()->startAnimation(animConfig);
    } else {
        session.fails++;
        LOG_I(TAG, "MISS! pressed=%d pos=%d marker=%d window=%d fails=%d/%d",
            session.playerPressed, session.symbolPosition, config.markerPosition,
            config.timingWindow, session.fails, config.failsAllowed);

        // Brief red flash
        AnimationConfig animConfig;
        animConfig.type = AnimationType::IDLE;
        animConfig.initialState = EXPLOIT_SEQ_MISS_STATE;
        animConfig.loop = false;
        PDN->getLightManager()->startAnimation(animConfig);
    }

    // Check if too many fails
    if (session.fails > config.failsAllowed) {
        transitionToLoseState = true;
        return;
    }

    // Advance exploit counter
    session.currentExploit++;

    // If all exploits in this sequence are done, advance sequence
    if (session.currentExploit >= config.exploitsPerSeq) {
        session.currentExploit = 0;
        session.currentSequence++;

        // If all sequences are done, win
        if (session.currentSequence >= config.sequences) {
            transitionToWinState = true;
            return;
        }
    }

    // Reset for next exploit and go to Show
    session.symbolPosition = 0;
    session.playerPressed = false;
    transitionToShowState = true;
}

void ExploitSequencerEvaluate::onStateLoop(Device* PDN) {
    // Transitions are determined in onStateMounted â€” nothing to do here
}

void ExploitSequencerEvaluate::onStateDismounted(Device* PDN) {
    transitionToShowState = false;
    transitionToWinState = false;
    transitionToLoseState = false;
}

bool ExploitSequencerEvaluate::transitionToShow() {
    return transitionToShowState;
}

bool ExploitSequencerEvaluate::transitionToWin() {
    return transitionToWinState;
}

bool ExploitSequencerEvaluate::transitionToLose() {
    return transitionToLoseState;
}
