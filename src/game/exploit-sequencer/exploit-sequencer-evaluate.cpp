#include "game/exploit-sequencer/exploit-sequencer-states.hpp"
#include "game/exploit-sequencer/exploit-sequencer.hpp"
#include "game/exploit-sequencer/exploit-sequencer-resources.hpp"
#include "device/drivers/logger.hpp"

static const char* TAG = "ExploitSeqEvaluate";

ExploitSequencerEvaluate::ExploitSequencerEvaluate(ExploitSequencer* game) : State(EXPLOIT_EVALUATE) {
    this->game = game;
}

ExploitSequencerEvaluate::~ExploitSequencerEvaluate() {
    game = nullptr;
}

void ExploitSequencerEvaluate::onStateMounted(Device* PDN) {
    transitionToShowState = false;
    transitionToWinState = false;
    transitionToLoseState = false;

    auto& session = game->getSession();
    auto& config = game->getConfig();

    LOG_I(TAG, "Round %d complete: P=%d G=%d M=%d Lives=%d Score=%d",
        session.currentRound + 1, session.perfectCount, session.goodCount,
        session.missCount, session.livesRemaining, session.score);

    // Check if player lost (no lives remaining)
    if (session.livesRemaining <= 0) {
        transitionToLoseState = true;
        return;
    }

    // Advance to next round
    session.currentRound++;

    // Check if all rounds complete (win condition)
    if (session.currentRound >= config.rounds) {
        transitionToWinState = true;
        return;
    }

    // Clear pattern for next round
    session.currentPattern.clear();
    session.currentNoteIndex = 0;

    // Brief animation based on performance
    if (session.missCount == 0) {
        // Perfect round - green flash
        AnimationConfig animConfig;
        animConfig.type = AnimationType::IDLE;
        animConfig.initialState = EXPLOIT_SEQ_HIT_STATE;
        animConfig.loop = false;
        PDN->getLightManager()->startAnimation(animConfig);
    } else if (session.livesRemaining == 1) {
        // Low lives - red flash warning
        AnimationConfig animConfig;
        animConfig.type = AnimationType::IDLE;
        animConfig.initialState = EXPLOIT_SEQ_MISS_STATE;
        animConfig.loop = false;
        PDN->getLightManager()->startAnimation(animConfig);
    }

    // Go to Show for next round
    transitionToShowState = true;
}

void ExploitSequencerEvaluate::onStateLoop(Device* PDN) {
    // Transitions are determined in onStateMounted â€” nothing to do here
}

void ExploitSequencerEvaluate::onStateDismounted(Device* PDN) {
    transitionToShowState = false;
    transitionToWinState = false;
    transitionToLoseState = false;
}

bool ExploitSequencerEvaluate::transitionToShow() {
    return transitionToShowState;
}

bool ExploitSequencerEvaluate::transitionToWin() {
    return transitionToWinState;
}

bool ExploitSequencerEvaluate::transitionToLose() {
    return transitionToLoseState;
}
