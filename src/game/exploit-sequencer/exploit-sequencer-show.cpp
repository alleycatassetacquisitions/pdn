#include "game/exploit-sequencer/exploit-sequencer-states.hpp"
#include "game/exploit-sequencer/exploit-sequencer.hpp"
#include "game/exploit-sequencer/exploit-sequencer-resources.hpp"
#include "device/drivers/logger.hpp"
#include <string>

static const char* TAG = "ExploitSeqShow";

ExploitSequencerShow::ExploitSequencerShow(ExploitSequencer* game) : State(EXPLOIT_SHOW) {
    this->game = game;
}

ExploitSequencerShow::~ExploitSequencerShow() {
    game = nullptr;
}

void ExploitSequencerShow::onStateMounted(Device* PDN) {
    transitionToGameplayState = false;

    auto& session = game->getSession();
    auto& config = game->getConfig();

    LOG_I(TAG, "Round %d/%d, Lives %d, Score %d",
        session.currentRound + 1, config.rounds,
        session.livesRemaining, session.score);

    // Display round info
    PDN->getDisplay()->invalidateScreen();

    std::string roundStr = "ROUND " + std::to_string(session.currentRound + 1) +
                           "/" + std::to_string(config.rounds);
    std::string livesStr = "Lives: " + std::to_string(session.livesRemaining);
    std::string scoreStr = "Score: " + std::to_string(session.score);

    PDN->getDisplay()->setGlyphMode(FontMode::TEXT)
        ->drawText(roundStr.c_str(), 20, 15)
        ->drawText(livesStr.c_str(), 30, 35)
        ->drawText(scoreStr.c_str(), 30, 50);
    PDN->getDisplay()->render();

    // Haptic pulse to signal upcoming round
    PDN->getHaptics()->setIntensity(100);

    showTimer.setTimer(SHOW_DURATION_MS);
}

void ExploitSequencerShow::onStateLoop(Device* PDN) {
    if (showTimer.expired()) {
        PDN->getHaptics()->off();
        transitionToGameplayState = true;
    }
}

void ExploitSequencerShow::onStateDismounted(Device* PDN) {
    showTimer.invalidate();
    transitionToGameplayState = false;
    PDN->getHaptics()->off();
}

bool ExploitSequencerShow::transitionToGameplay() {
    return transitionToGameplayState;
}
