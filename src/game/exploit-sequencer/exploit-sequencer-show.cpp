#include "game/exploit-sequencer/exploit-sequencer-states.hpp"
#include "game/exploit-sequencer/exploit-sequencer.hpp"
#include "game/exploit-sequencer/exploit-sequencer-resources.hpp"
#include "device/drivers/logger.hpp"
#include <string>

static const char* TAG = "ExploitSeqShow";

ExploitSequencerShow::ExploitSequencerShow(ExploitSequencer* game) : State(EXPLOIT_SHOW) {
    this->game = game;
}

ExploitSequencerShow::~ExploitSequencerShow() {
    game = nullptr;
}

void ExploitSequencerShow::onStateMounted(Device* PDN) {
    transitionToGameplayState = false;

    auto& session = game->getSession();
    auto& config = game->getConfig();

    // Reset for the next exploit attempt
    session.symbolPosition = 0;
    session.playerPressed = false;

    LOG_I(TAG, "Seq %d/%d, Exploit %d/%d, Fails %d/%d",
        session.currentSequence + 1, config.sequences,
        session.currentExploit + 1, config.exploitsPerSeq,
        session.fails, config.failsAllowed);

    // Display sequence info
    PDN->getDisplay()->invalidateScreen();

    std::string seqStr = "Seq " + std::to_string(session.currentSequence + 1) +
                         " of " + std::to_string(config.sequences);
    std::string exploitStr = "Exploit " + std::to_string(session.currentExploit + 1) +
                             " of " + std::to_string(config.exploitsPerSeq);
    int failsRemaining = config.failsAllowed - session.fails;
    std::string failsStr = "Fails left: " + std::to_string(failsRemaining);

    PDN->getDisplay()->setGlyphMode(FontMode::TEXT)
        ->drawText(seqStr.c_str(), 10, 15)
        ->drawText(exploitStr.c_str(), 10, 35)
        ->drawText(failsStr.c_str(), 10, 55);
    PDN->getDisplay()->render();

    // Haptic pulse to signal upcoming exploit
    PDN->getHaptics()->setIntensity(100);

    showTimer.setTimer(SHOW_DURATION_MS);
}

void ExploitSequencerShow::onStateLoop(Device* PDN) {
    if (showTimer.expired()) {
        PDN->getHaptics()->off();
        transitionToGameplayState = true;
    }
}

void ExploitSequencerShow::onStateDismounted(Device* PDN) {
    showTimer.invalidate();
    transitionToGameplayState = false;
    PDN->getHaptics()->off();
}

bool ExploitSequencerShow::transitionToGameplay() {
    return transitionToGameplayState;
}
