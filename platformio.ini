; PlatformIO Project Configuration File

[platformio]
name = "AAA PDN"
default_envs = esp32-s3_release
extra_configs = wifi_credentials.ini

; ========================================
; ESP32-S3 BUILD ENVIRONMENTS
; ========================================

; Base configuration for ESP32-S3 builds
[env:esp32-s3_base]
platform = https://github.com/pioarduino/platform-espressif32/releases/download/stable/platform-espressif32.zip
board = esp32-s3-n8r8
board_build.arduino.memory_type = dio_opi
framework = arduino
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

build_src_filter =
    +<*>
    -<native-main.cpp>
    -<cli-main.cpp>
    -<perf-main.cpp>
    -<cli/*>
    -<device/drivers/native/*>

build_flags =
    -DBOARD_HAS_PSRAM
    '-DWIFI_SSID="${wifi.WIFI_SSID}"'
    '-DWIFI_PASSWORD="${wifi.WIFI_PASSWORD}"'
    '-DBASE_URL="${wifi.BASE_URL}"'

; Library dependencies
lib_deps =
    olikraus/U8g2@^2.35.14
    fastled/FastLED@^3.6.0
    mathertel/OneButton@^2.5.0
    ArduinoJson@^7.4.2
    WiFi

; Debug build
[env:esp32-s3_debug]
extends = env:esp32-s3_base
build_type = debug
build_flags =
    ${env:esp32-s3_base.build_flags}
    -DCORE_DEBUG_LEVEL=5
    -DARDUINO_USB_MODE=1
debug_tool = esp-builtin
debug_init_break = tbreak loop

; Release build (default)
[env:esp32-s3_release]
extends = env:esp32-s3_base
build_type = release
build_flags =
    ${env:esp32-s3_base.build_flags}
    -DCORE_DEBUG_LEVEL=2

; Release with verbose logging
[env:esp32-s3_release_verbose]
extends = env:esp32-s3_base
build_type = release
build_flags =
    ${env:esp32-s3_base.build_flags}
    -DCORE_DEBUG_LEVEL=5

; ========================================
; NATIVE TEST ENVIRONMENT
; ========================================

[env:native]
platform = native
build_type = test
test_framework = googletest
test_build_src = yes
test_filter = test_core

build_flags =
    -std=c++17
    -DNATIVE_BUILD

; Exclude ESP32-specific files and CLI-specific files from native builds
build_src_filter =
    +<*>
    -<main.cpp>
    -<native-main.cpp>
    -<cli-main.cpp>
    -<device/drivers/esp32-s3/*>

lib_deps = 
    googletest
    bblanchon/ArduinoJson@^7.4.2
build_unflags = -Werror

; ========================================
; NATIVE ASAN ENVIRONMENT (Memory / leak detection)
; ========================================
; Run in WSL: pio test -e native_asan
; Enables AddressSanitizer + LeakSanitizer.
; Any heap overflows, use-after-free, or leaks are reported
; inline with a full stack trace after the test run.

[env:native_asan]
extends = env:native
build_flags =
    -std=c++17
    -DNATIVE_BUILD
    -fsanitize=address,leak
    -fno-omit-frame-pointer
    -g
    -O1
build_unflags = -Werror

; ========================================
; NATIVE PROFILE ENVIRONMENT (CPU profiling via perf)
; ========================================

[env:native_profile]
extends = env:native
build_flags =
    -std=c++17
    -DNATIVE_BUILD
    -g
    -O2
    -fno-omit-frame-pointer
build_unflags = -Werror

; ========================================
; NATIVE PERF ENVIRONMENT (Business-logic duel benchmark)
; ========================================
; Builds a standalone executable with no test framework overhead.
; Uses null-logger and stub drivers so only game logic is hot.
;
; Build:   pio run -e native_perf
; Run:     .pio/build/native_perf/program [NUM_DUELS]
; Profile:
;   valgrind --tool=callgrind --callgrind-out-file=callgrind.out \
;     .pio/build/native_perf/program 50000
;   callgrind_annotate --auto=yes callgrind.out > callgrind_report.txt

[env:native_perf]
platform = native
build_type = release

build_flags =
    -std=c++17
    -DNATIVE_BUILD
    -DPERF_BUILD
    -DCORE_DEBUG_LEVEL=0
    -g
    -O2
    -fno-omit-frame-pointer

build_src_filter =
    +<*>
    -<main.cpp>
    -<native-main.cpp>
    -<cli-main.cpp>
    -<device/drivers/esp32-s3/*>

lib_deps =
    bblanchon/ArduinoJson@^7.4.2

build_unflags = -Werror

; ========================================
; NATIVE CLI ENVIRONMENT (PDN Simulator)
; ========================================
; PLATFORM REQUIREMENT: Unix/POSIX only (Linux, macOS)
; Windows users should use WSL or Git Bash.
; This tool requires POSIX terminal APIs (termios, fcntl).

[env:native_cli]
platform = native
build_type = release

build_flags =
    -std=c++17
    -DNATIVE_BUILD
    -pthread

; Include cli-main.cpp for the CLI app, exclude ESP32 drivers and other main files
build_src_filter =
    +<*>
    -<main.cpp>
    -<native-main.cpp>
    -<device/drivers/esp32-s3/*>

lib_deps = 
    bblanchon/ArduinoJson@^7.4.2

build_unflags = -Werror

; ========================================
; NATIVE CLI TEST ENVIRONMENT
; ========================================
; Tests for CLI components (without the actual terminal UI)

[env:native_cli_test]
platform = native
build_type = test
test_framework = googletest
test_build_src = yes
test_filter = test_cli

build_flags =
    -std=c++17
    -DNATIVE_BUILD
    -pthread

; Exclude cli-main.cpp for tests (has its own main, conflicts with gtest)
build_src_filter =
    +<*>
    -<main.cpp>
    -<native-main.cpp>
    -<cli-main.cpp>
    -<device/drivers/esp32-s3/*>

lib_deps = 
    googletest
    bblanchon/ArduinoJson@^7.4.2

build_unflags = -Werror