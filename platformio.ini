; PlatformIO Project Configuration File

[platformio]
name = "AAA PDN"
default_envs = esp32-s3_release

; ========================================
; ESP32-S3 BUILD ENVIRONMENTS
; ========================================

; Base configuration for ESP32-S3 builds
[env:esp32-s3_base]
platform = https://github.com/platformio/platform-espressif32.git
board = esp32-s3-n8r8
board_build.arduino.memory_type = dio_opi
framework = arduino
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; Extra script for compile_commands.json generation (SonarQube support)
extra_scripts = pre:extra_script.py

build_src_filter =
    +<*>
    -<native-main.cpp>
    -<device/drivers/native/*>

build_flags =
    -DBOARD_HAS_PSRAM

; Library dependencies
lib_deps =
    olikraus/U8g2@^2.35.14
    fastled/FastLED@^3.6.0
    mathertel/OneButton@^2.5.0
    ArduinoJson
    WiFi

; Debug build
[env:esp32-s3_debug]
extends = env:esp32-s3_base
build_type = debug
build_flags =
    ${env:esp32-s3_base.build_flags}
    -DCORE_DEBUG_LEVEL=5
    -DARDUINO_USB_MODE=1
debug_tool = esp-builtin
debug_init_break = tbreak loop

; Release build (default)
[env:esp32-s3_release]
extends = env:esp32-s3_base
build_type = release
build_flags =
    ${env:esp32-s3_base.build_flags}
    -DCORE_DEBUG_LEVEL=2

; Release with verbose logging
[env:esp32-s3_release_verbose]
extends = env:esp32-s3_base
build_type = release
build_flags =
    ${env:esp32-s3_base.build_flags}
    -DCORE_DEBUG_LEVEL=5

; ========================================
; NATIVE TEST ENVIRONMENT
; ========================================

[env:native]
platform = native
build_type = test
test_framework = googletest
test_build_src = yes
test_filter = test_core

; Extra script for compile_commands.json generation (SonarQube support)
extra_scripts = pre:extra_script.py

build_flags =
    -std=c++17
    -DNATIVE_BUILD

; Exclude ESP32-specific files and CLI-specific files from native builds
build_src_filter =
    +<*>
    -<main.cpp>
    -<native-main.cpp>
    -<cli-main.cpp>
    -<device/drivers/esp32-s3/*>

lib_deps = 
    googletest
    bblanchon/ArduinoJson@^7
build_unflags = -Werror

; ========================================
; NATIVE APP ENVIRONMENT (CLI Simulator)
; ========================================

[env:native_app]
platform = native
build_type = release

; Extra script for compile_commands.json generation (SonarQube support)
extra_scripts = pre:extra_script.py

build_flags =
    -std=c++17
    -DNATIVE_BUILD
    -pthread

; Include native-main.cpp, exclude ESP32 files and test files
build_src_filter =
    +<*>
    -<main.cpp>
    -<device/drivers/esp32-s3/*>

lib_deps = 
    bblanchon/ArduinoJson@^7

build_unflags = -Werror

; ========================================
; NATIVE CLI ENVIRONMENT (PDN Simulator)
; ========================================
; PLATFORM REQUIREMENT: Unix/POSIX only (Linux, macOS)
; Windows users should use WSL or Git Bash.
; This tool requires POSIX terminal APIs (termios, fcntl).

[env:native_cli]
platform = native
build_type = release
test_framework = googletest
test_build_src = yes
test_filter = test_cli

; Extra script for compile_commands.json generation (SonarQube support)
extra_scripts = pre:extra_script.py

build_flags =
    -std=c++17
    -DNATIVE_BUILD
    -pthread

; Include all source files except main.cpp, native-main.cpp, cli-main.cpp, and ESP32-specific drivers
; cli-main.cpp requires POSIX terminal APIs - tests should not depend on it
build_src_filter =
    +<*>
    -<main.cpp>
    -<native-main.cpp>
    -<cli-main.cpp>
    -<device/drivers/esp32-s3/*>

lib_deps = 
    googletest
    bblanchon/ArduinoJson@^7

build_unflags = -Werror
