#pragma once

#include "game/minigame.hpp"
#include "game/exploit-sequencer/exploit-sequencer-states.hpp"
#include <cstdlib>

constexpr int EXPLOIT_SEQUENCER_APP_ID = 7;

struct ExploitSequencerConfig {
    int scrollSpeedMs = 40;       // ms per scroll step
    int scrollLength = 100;       // symbol travels 0 to scrollLength
    int markerPosition = 50;      // where the timing marker is
    int timingWindow = 10;        // +/- window around marker for correct press
    int exploitsPerSeq = 3;       // exploits to land per sequence
    int sequences = 3;            // total sequences to complete
    int failsAllowed = 2;         // failed exploits before game over
    unsigned long rngSeed = 0;
    bool managedMode = false;
};

struct ExploitSequencerSession {
    int symbolPosition = 0;       // current symbol scroll position
    int currentExploit = 0;       // which exploit in current sequence (0-based)
    int currentSequence = 0;      // which sequence (0-based)
    int fails = 0;                // total failed exploits
    int score = 0;
    bool playerPressed = false;   // true when player presses during this exploit
    void reset() {
        symbolPosition = 0;
        currentExploit = 0;
        currentSequence = 0;
        fails = 0;
        score = 0;
        playerPressed = false;
    }
};

inline ExploitSequencerConfig makeExploitSequencerEasyConfig() {
    ExploitSequencerConfig c;
    c.scrollSpeedMs = 40;
    c.scrollLength = 100;
    c.markerPosition = 50;
    c.timingWindow = 15;     // wide window
    c.exploitsPerSeq = 2;
    c.sequences = 2;
    c.failsAllowed = 3;
    return c;
}

inline ExploitSequencerConfig makeExploitSequencerHardConfig() {
    ExploitSequencerConfig c;
    c.scrollSpeedMs = 25;    // faster scroll
    c.scrollLength = 100;
    c.markerPosition = 50;
    c.timingWindow = 6;      // narrow window
    c.exploitsPerSeq = 4;
    c.sequences = 4;
    c.failsAllowed = 1;
    return c;
}

const ExploitSequencerConfig EXPLOIT_SEQUENCER_EASY = makeExploitSequencerEasyConfig();
const ExploitSequencerConfig EXPLOIT_SEQUENCER_HARD = makeExploitSequencerHardConfig();

/*
 * Exploit Sequencer -- QTE / Code Injection minigame.
 *
 * Symbols scroll across a buffer. Player presses PRIMARY when the
 * exploit symbol reaches the marker position. Multiple exploits per
 * sequence, multiple sequences per game. Complete all sequences to
 * win, exceed allowed failures to lose.
 *
 * In managed mode (via FDN), terminal states call
 * Device::returnToPreviousApp(). In standalone mode, loops to intro.
 */
class ExploitSequencer : public MiniGame {
public:
    explicit ExploitSequencer(ExploitSequencerConfig config) :
        MiniGame(EXPLOIT_SEQUENCER_APP_ID, GameType::EXPLOIT_SEQUENCER, "EXPLOIT SEQUENCER"),
        config(config)
    {
    }

    void populateStateMap() override;
    void resetGame() override;

    ExploitSequencerConfig& getConfig() { return config; }
    ExploitSequencerSession& getSession() { return session; }

    void seedRng();

private:
    ExploitSequencerConfig config;
    ExploitSequencerSession session;
};
