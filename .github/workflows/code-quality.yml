name: Code Quality

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  binary-size:
    runs-on: [self-hosted, pdn-ci]
    steps:
      - uses: actions/checkout@v4
      - name: Create WiFi credentials
        run: |
          cp wifi_credentials.ini.example wifi_credentials.ini
          sed -i 's/YourWiFiSSID/CI_SSID/' wifi_credentials.ini
          sed -i 's/YourWiFiPassword/CI_PASSWORD/' wifi_credentials.ini
          sed -i 's|https://your-api-endpoint.com/api/v1|http://localhost:3000|' wifi_credentials.ini
      - name: Build
        run: pio run -e native_cli
      - name: Check binary size
        run: |
          size .pio/build/native_cli/program > /tmp/size-output.txt
          cat /tmp/size-output.txt
          python3 scripts/check-binary-size.py docs/baselines/binary-size.json /tmp/size-output.txt

  duplication:
    runs-on: [self-hosted, pdn-ci]
    steps:
      - uses: actions/checkout@v4
      - name: Run CPD
        run: |
          /opt/pmd-bin-7.0.0/bin/pmd cpd --minimum-tokens 50 --language cpp --dir src/ --dir include/ --format text --skip-lexical-errors > /tmp/cpd-output.txt 2>&1 || true
          cat /tmp/cpd-output.txt
          python3 scripts/check-duplication.py docs/baselines/duplication.json /tmp/cpd-output.txt

  static-analysis:
    runs-on: [self-hosted, pdn-ci]
    steps:
      - uses: actions/checkout@v4
      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,style,performance,portability \
            --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --inline-suppr \
            -I include/ \
            src/ 2>&1 | tee /tmp/cppcheck-output.txt || echo "Cppcheck found issues"
          if grep -q "error:" /tmp/cppcheck-output.txt; then
            echo "❌ Critical issues found"
            exit 1
          else
            echo "✅ No critical issues found"
          fi
