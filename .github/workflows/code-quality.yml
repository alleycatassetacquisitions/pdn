name: Code Quality

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  binary-size:
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install PlatformIO
        run: pip install platformio
      - name: Create WiFi credentials
        run: |
          cp wifi_credentials.ini.example wifi_credentials.ini
          sed -i 's/YourWiFiSSID/CI_SSID/' wifi_credentials.ini
          sed -i 's/YourWiFiPassword/CI_PASSWORD/' wifi_credentials.ini
          sed -i 's|https://your-api-endpoint.com/api/v1|http://localhost:3000|' wifi_credentials.ini
      - name: Build
        run: pio run -e native_cli
      - name: Check binary size
        run: |
          # Capture current sizes
          size .pio/build/native_cli/program > /tmp/size-output.txt
          cat /tmp/size-output.txt
          # Compare against baseline
          python3 scripts/check-binary-size.py docs/baselines/binary-size.json /tmp/size-output.txt

  duplication:
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4
      - name: Install unzip
        run: |
          if ! command -v unzip &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y unzip || echo "::warning::Could not install unzip"
          else
            echo "unzip already installed"
          fi
      - name: Download PMD
        run: |
          wget -q https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.0.0/pmd-dist-7.0.0-bin.zip
          if command -v unzip &> /dev/null; then
            unzip -q pmd-dist-7.0.0-bin.zip
          else
            python3 -c "import zipfile; zipfile.ZipFile('pmd-dist-7.0.0-bin.zip').extractall()"
          fi
      - name: Run CPD
        run: |
          ./pmd-bin-7.0.0/bin/pmd cpd --minimum-tokens 50 --language cpp --dir src/ --dir include/ --format text --skip-lexical-errors > /tmp/cpd-output.txt 2>&1 || true
          cat /tmp/cpd-output.txt
          python3 scripts/check-duplication.py docs/baselines/duplication.json /tmp/cpd-output.txt

  static-analysis:
    runs-on: [self-hosted, linux, x64]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install cppcheck
        run: |
          if command -v cppcheck &> /dev/null; then
            echo "cppcheck already installed: $(cppcheck --version)"
          else
            echo "Installing cppcheck via pip..."
            pip install cppcheck 2>/dev/null || sudo apt-get update && sudo apt-get install -y cppcheck || echo "::warning::Could not install cppcheck, skipping static analysis"
          fi
      - name: Run cppcheck
        run: |
          if ! command -v cppcheck &> /dev/null; then
            echo "::warning::cppcheck not available, skipping static analysis"
            exit 0
          fi
          cppcheck --enable=warning,style,performance,portability \
            --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --inline-suppr \
            -I include/ \
            src/ 2>&1 | tee /tmp/cppcheck-output.txt || echo "Cppcheck found issues"
          # Only fail on high severity issues (errors)
          if grep -q "error:" /tmp/cppcheck-output.txt; then
            echo "❌ Critical issues found"
            exit 1
          else
            echo "✅ No critical issues found"
          fi
