name: Duplicate File Detection

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-duplicate-files:
    runs-on: [self-hosted, pdn-ci]
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get added files in this PR
        id: get-added-files
        run: |
          BASE_REF="${{ github.event.pull_request.base.sha }}"
          HEAD_REF="${{ github.event.pull_request.head.sha }}"
          echo "Comparing $BASE_REF...$HEAD_REF"
          ADDED_FILES=$(git diff --name-only --diff-filter=A "$BASE_REF...$HEAD_REF")
          if [ -z "$ADDED_FILES" ]; then
            echo "No new files added in this PR"
            echo "has_added_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Files added in this PR:"
          echo "$ADDED_FILES"
          echo "has_added_files=true" >> $GITHUB_OUTPUT
          echo "added_files<<EOF" >> $GITHUB_OUTPUT
          echo "$ADDED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for duplicates in other PRs
        if: steps.get-added-files.outputs.has_added_files == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          CURRENT_PR: ${{ github.event.pull_request.number }}
        run: |
          ADDED_FILES="${{ steps.get-added-files.outputs.added_files }}"
          OTHER_PRS=$(gh pr list --repo ${{ github.repository }} --state open --json number,headRefName --jq ".[] | select(.number != $CURRENT_PR) | .number")
          if [ -z "$OTHER_PRS" ]; then
            echo "No other open PRs to check"
            exit 0
          fi
          CONFLICTS_FOUND=false
          CONFLICT_REPORT=""
          for PR_NUM in $OTHER_PRS; do
            echo "Checking PR #$PR_NUM..."
            OTHER_ADDED=$(gh pr diff $PR_NUM --name-only | xargs -I {} sh -c 'git diff --name-only --diff-filter=A origin/${{ github.event.pull_request.base.ref }}...$(gh pr view '"$PR_NUM"' --json headRefName -q .headRefName) | grep -Fx "{}" || true')
            if [ -z "$OTHER_ADDED" ]; then
              continue
            fi
            DUPLICATES=""
            while IFS= read -r file; do
              if echo "$OTHER_ADDED" | grep -Fxq "$file"; then
                DUPLICATES="$DUPLICATES$file"$'\n'
                CONFLICTS_FOUND=true
              fi
            done <<< "$ADDED_FILES"
            if [ -n "$DUPLICATES" ]; then
              CONFLICT_REPORT="$CONFLICT_REPORT"$'\n'"### Conflict with PR #$PR_NUM"$'\n'
              CONFLICT_REPORT="$CONFLICT_REPORT"$'\n'"The following files are added in both PRs:"$'\n'
              while IFS= read -r dup_file; do
                if [ -n "$dup_file" ]; then
                  CONFLICT_REPORT="$CONFLICT_REPORT- \`$dup_file\`"$'\n'
                fi
              done <<< "$DUPLICATES"
            fi
          done
          if [ "$CONFLICTS_FOUND" = true ]; then
            echo "conflicts_found=true" >> $GITHUB_ENV
            echo "CONFLICT_REPORT<<EOF" >> $GITHUB_ENV
            echo "$CONFLICT_REPORT" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "conflicts_found=false" >> $GITHUB_ENV
            echo "No duplicate file creation detected"
          fi

      - name: Post warning comment
        if: env.conflicts_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const report = process.env.CONFLICT_REPORT;
            const body = `## ⚠️ Duplicate File Creation Detected

            This PR adds files that are also being added in other open PRs. This may cause merge conflicts.

            ${report}

            ### What to do:
            - Coordinate with the other PR author(s)
            - Consider if the files should be shared or separate
            - One PR may need to wait for the other to merge first

            *This is a warning, not a blocking error.*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Set check status
        if: env.conflicts_found == 'true'
        run: |
          echo "::warning::Duplicate file creation detected. See PR comments for details."
          exit 0
