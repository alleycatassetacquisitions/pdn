name: Duplicate File Detection

on:
  pull_request:
    types: [opened, synchronize, reopened]
  merge_group:

jobs:
  check-duplicate-files:
    if: github.event_name == 'pull_request'
    runs-on: [self-hosted, linux, x64]
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gh CLI
        run: |
          if command -v gh &> /dev/null; then
            echo "gh CLI already installed"
            exit 0
          fi
          echo "Attempting to install gh CLI..."
          (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg 2>/dev/null \
            && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
            && sudo apt-get update && sudo apt-get install -y gh) 2>/dev/null || echo "::warning::Could not install gh CLI — duplicate file check will be skipped"

      - name: Get added files in this PR
        id: get-added-files
        run: |
          # Get the base and head refs
          BASE_REF="${{ github.event.pull_request.base.sha }}"
          HEAD_REF="${{ github.event.pull_request.head.sha }}"

          echo "Comparing $BASE_REF...$HEAD_REF"

          # Get list of added files (not modified)
          ADDED_FILES=$(git diff --name-only --diff-filter=A "$BASE_REF...$HEAD_REF")

          if [ -z "$ADDED_FILES" ]; then
            echo "No new files added in this PR"
            echo "has_added_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Files added in this PR:"
          echo "$ADDED_FILES"

          # Save to output (escape newlines for GitHub Actions)
          echo "has_added_files=true" >> $GITHUB_OUTPUT
          echo "added_files<<EOF" >> $GITHUB_OUTPUT
          echo "$ADDED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for duplicates in other PRs
        if: steps.get-added-files.outputs.has_added_files == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          CURRENT_PR: ${{ github.event.pull_request.number }}
        run: |
          if ! command -v gh &> /dev/null; then
            echo "::warning::gh CLI not available, skipping duplicate file check"
            exit 0
          fi

          ADDED_FILES="${{ steps.get-added-files.outputs.added_files }}"

          # Get list of all open PRs except this one
          OTHER_PRS=$(gh pr list --repo ${{ github.repository }} --state open --json number,headRefName --jq ".[] | select(.number != $CURRENT_PR) | .number")

          if [ -z "$OTHER_PRS" ]; then
            echo "No other open PRs to check"
            exit 0
          fi

          CONFLICTS_FOUND=false
          CONFLICT_REPORT=""

          # Check each other PR for conflicting added files
          for PR_NUM in $OTHER_PRS; do
            echo "Checking PR #$PR_NUM..."

            # Get added files in the other PR
            OTHER_ADDED=$(gh pr diff $PR_NUM --name-only | xargs -I {} sh -c 'git diff --name-only --diff-filter=A origin/${{ github.event.pull_request.base.ref }}...$(gh pr view '"$PR_NUM"' --json headRefName -q .headRefName) | grep -Fx "{}" || true')

            if [ -z "$OTHER_ADDED" ]; then
              continue
            fi

            # Find intersection of added files
            DUPLICATES=""
            while IFS= read -r file; do
              if echo "$OTHER_ADDED" | grep -Fxq "$file"; then
                DUPLICATES="$DUPLICATES$file"$'\n'
                CONFLICTS_FOUND=true
              fi
            done <<< "$ADDED_FILES"

            if [ -n "$DUPLICATES" ]; then
              CONFLICT_REPORT="$CONFLICT_REPORT"$'\n'"### Conflict with PR #$PR_NUM"$'\n'
              CONFLICT_REPORT="$CONFLICT_REPORT"$'\n'"The following files are added in both PRs:"$'\n'
              while IFS= read -r dup_file; do
                if [ -n "$dup_file" ]; then
                  CONFLICT_REPORT="$CONFLICT_REPORT- \`$dup_file\`"$'\n'
                fi
              done <<< "$DUPLICATES"
            fi
          done

          # Save result
          if [ "$CONFLICTS_FOUND" = true ]; then
            echo "conflicts_found=true" >> $GITHUB_ENV
            echo "CONFLICT_REPORT<<EOF" >> $GITHUB_ENV
            echo "$CONFLICT_REPORT" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "conflicts_found=false" >> $GITHUB_ENV
            echo "No duplicate file creation detected"
          fi

      - name: Post warning comment
        if: env.conflicts_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const report = process.env.CONFLICT_REPORT;
            const body = `## ⚠️ Duplicate File Creation Detected

            This PR adds files that are also being added in other open PRs. This may cause merge conflicts.

            ${report}

            ### What to do:
            - Coordinate with the other PR author(s)
            - Consider if the files should be shared or separate
            - One PR may need to wait for the other to merge first

            *This is a warning, not a blocking error.*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Set check status
        if: env.conflicts_found == 'true'
        run: |
          echo "::warning::Duplicate file creation detected. See PR comments for details."
          exit 0
