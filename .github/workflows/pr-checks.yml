name: PR Checks

on:
  pull_request:
    branches: main
  push:
    branches: main
  merge_group:
  workflow_dispatch:

jobs:
  # Shared setup as a reusable pattern
  test:
    runs-on: [self-hosted, linux, x64]
    outputs:
      core-count: ${{ steps.core-tests.outputs.count }}
      cli-count: ${{ steps.cli-tests.outputs.count }}

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'true'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio

    - name: Cache PlatformIO dependencies
      uses: actions/cache@v4
      with:
        path: ~/.platformio
        key: ${{ runner.os }}-pio-test-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-test-
          ${{ runner.os }}-pio-

    - name: Create WiFi credentials
      run: |
        cp wifi_credentials.ini.example wifi_credentials.ini
        sed -i 's/YourWiFiSSID/CI_SSID/' wifi_credentials.ini
        sed -i 's/YourWiFiPassword/CI_PASSWORD/' wifi_credentials.ini
        sed -i 's|https://your-api-endpoint.com/api/v1|http://localhost:3000|' wifi_credentials.ini

    - name: Run Core Unit Tests
      id: core-tests
      run: |
        OUTPUT=$(pio test -e native 2>&1) || true
        echo "$OUTPUT"
        COUNT=$(echo "$OUTPUT" | grep -oP '\d+ test cases' | grep -oP '\d+' | head -1)
        PASSED=$(echo "$OUTPUT" | grep -oP '\d+ succeeded' | grep -oP '\d+' | head -1)
        echo "count=${COUNT:-0}" >> $GITHUB_OUTPUT
        echo "passed=${PASSED:-0}" >> $GITHUB_OUTPUT
        if echo "$OUTPUT" | grep -q "FAILED"; then
          exit 1
        fi

    - name: Run CLI Unit Tests
      id: cli-tests
      run: |
        OUTPUT=$(pio test -e native_cli_test 2>&1) || true
        echo "$OUTPUT"
        COUNT=$(echo "$OUTPUT" | grep -oP '\d+ test cases' | grep -oP '\d+' | head -1)
        PASSED=$(echo "$OUTPUT" | grep -oP '\d+ succeeded' | grep -oP '\d+' | head -1)
        echo "count=${COUNT:-0}" >> $GITHUB_OUTPUT
        echo "passed=${PASSED:-0}" >> $GITHUB_OUTPUT
        if echo "$OUTPUT" | grep -q "FAILED"; then
          exit 1
        fi

    - name: Test Summary
      if: always()
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Suite | Tests | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Core | ${{ steps.core-tests.outputs.count }} | ${{ steps.core-tests.outcome == 'success' && '✅ PASS' || '❌ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| CLI | ${{ steps.cli-tests.outputs.count }} | ${{ steps.cli-tests.outcome == 'success' && '✅ PASS' || '❌ FAIL' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Total: $(( ${{ steps.core-tests.outputs.count || 0 }} + ${{ steps.cli-tests.outputs.count || 0 }} )) tests**" >> $GITHUB_STEP_SUMMARY

  # Update dynamic badges (only on main pushes and manual runs)
  badges:
    needs: test
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    runs-on: [self-hosted, linux, x64]

    steps:
    - name: Update test count badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.GIST_TOKEN }}
        gistID: 5b8fff0b3af6332b80904301c8f159cf
        filename: pdn-tests.json
        label: tests
        message: "${{ needs.test.outputs.cli-count }} CLI + ${{ needs.test.outputs.core-count }} core passing"
        color: brightgreen

  build-esp32:
    runs-on: [self-hosted, linux, x64]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'true'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio

    - name: Cache PlatformIO dependencies
      uses: actions/cache@v4
      with:
        path: ~/.platformio
        key: ${{ runner.os }}-pio-esp32-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-esp32-
          ${{ runner.os }}-pio-

    - name: Create WiFi credentials
      run: |
        cp wifi_credentials.ini.example wifi_credentials.ini
        sed -i 's/YourWiFiSSID/CI_SSID/' wifi_credentials.ini
        sed -i 's/YourWiFiPassword/CI_PASSWORD/' wifi_credentials.ini
        sed -i 's|https://your-api-endpoint.com/api/v1|http://localhost:3000|' wifi_credentials.ini

    - name: Build ESP32-S3 Release
      run: pio run -e esp32-s3_release

  build-cli:
    runs-on: [self-hosted, linux, x64]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'true'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio

    - name: Cache PlatformIO dependencies
      uses: actions/cache@v4
      with:
        path: ~/.platformio
        key: ${{ runner.os }}-pio-cli-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-cli-
          ${{ runner.os }}-pio-

    - name: Create WiFi credentials
      run: |
        cp wifi_credentials.ini.example wifi_credentials.ini
        sed -i 's/YourWiFiSSID/CI_SSID/' wifi_credentials.ini
        sed -i 's/YourWiFiPassword/CI_PASSWORD/' wifi_credentials.ini
        sed -i 's|https://your-api-endpoint.com/api/v1|http://localhost:3000|' wifi_credentials.ini

    - name: Build Native CLI
      run: pio run -e native_cli

  conflict-markers:
    runs-on: [self-hosted, linux, x64]
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for merge conflict markers
      run: |
        echo "Checking for merge conflict markers in PR files..."

        # Get the list of changed files in this PR
        git fetch origin ${{ github.base_ref }}
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

        if [ -z "$CHANGED_FILES" ]; then
          echo "No files changed in this PR"
          exit 0
        fi

        echo "Changed files:"
        echo "$CHANGED_FILES"
        echo ""

        # Check each changed file for conflict markers
        CONFLICTS_FOUND=0
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            # Search for conflict markers
            if grep -n -E '^(<{7}|={7}|>{7})' "$file"; then
              echo "❌ CONFLICT MARKERS FOUND in $file"
              CONFLICTS_FOUND=1
            fi
          fi
        done <<< "$CHANGED_FILES"

        if [ $CONFLICTS_FOUND -eq 1 ]; then
          echo ""
          echo "=========================================="
          echo "ERROR: Merge conflict markers detected!"
          echo "Please resolve all conflicts before merging."
          echo "=========================================="
          exit 1
        else
          echo "✅ No conflict markers found"
          exit 0
        fi
